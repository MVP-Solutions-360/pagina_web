<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Paquete - Agencia de Viajes</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/details-package.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-brand">
                    <i class="fas fa-plane"></i>
                    <span>Agencia de Viajes</span>
                </a>
                
                <div class="nav-menu">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        Inicio
                    </a>
                    <a href="packages.html" class="nav-link active">
                        <i class="fas fa-suitcase"></i>
                        Paquetes
                    </a>
                    <a href="index.html#destinos" class="nav-link">
                        <i class="fas fa-map-marker-alt"></i>
                        Destinos
                    </a>
                    <a href="index.html#contacto" class="nav-link">
                        <i class="fas fa-envelope"></i>
                        Contacto
                    </a>
                </div>
                
                <div class="nav-actions">
                    <a href="index.html#cotizacion" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        Cotizar
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="package-details-hero">
        <div class="container">
            <h1>Detalles del Paquete</h1>
            <div class="subtitle">Descubre todos los detalles de tu próximo viaje</div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="package-details-container">
        <!-- Botón Volver -->
        <a href="packages.html" class="back-to-packages">
            <i class="fas fa-arrow-left"></i>
            Volver a Paquetes
        </a>

        <!-- Loading Spinner -->
        <div id="package-loading" class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">Cargando detalles del paquete...</div>
        </div>

        <!-- Contenido del Paquete -->
        <div id="package-content" class="package-details-grid" style="display: none;">
            <!-- Contenido Principal -->
            <div class="package-main-content">
                <!-- Carrusel de Imágenes -->
                <div class="package-carousel">
                    <div class="carousel-container" id="carousel-container">
                        <!-- Las imágenes se cargarán dinámicamente -->
                    </div>
                    
                    <!-- Navegación del Carrusel -->
                    <button class="carousel-nav carousel-prev" id="carousel-prev" aria-label="Imagen anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-nav carousel-next" id="carousel-next" aria-label="Imagen siguiente">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <!-- Indicadores -->
                    <div class="carousel-indicators" id="carousel-indicators">
                        <!-- Los indicadores se generarán dinámicamente -->
                    </div>
                </div>
                
                <!-- Título y Badge de Destino -->
                <div class="package-header">
                    <h2 class="package-title" id="detail-title">Cargando...</h2>
                    <div class="destination-badge" id="destination-badge">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="destination-badge-text">Cargando...</span>
                    </div>
                </div>
                
                <!-- Información del Paquete -->
                <div class="package-info-grid">
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <div class="label">Destino</div>
                            <div class="value" id="detail-destination">Cargando...</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-plane-departure"></i>
                        <div>
                            <div class="label">Origen</div>
                            <div class="value" id="detail-origin">Cargando...</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <div>
                            <div class="label">Duración</div>
                            <div class="value" id="detail-duration">Cargando...</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-users"></i>
                        <div>
                            <div class="label">Grupo</div>
                            <div class="value" id="detail-group">Cargando...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Desplegable: Detalles del Paquete -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('details')">
                        <div class="section-title">
                            <i class="fas fa-info-circle section-icon"></i>
                            Detalles del Paquete
                        </div>
                        <i class="fas fa-chevron-down section-toggle" id="details-toggle"></i>
                    </div>
                    <div class="section-content" id="details-content">
                        <div class="section-body">
                            <div id="detail-full-description">Cargando detalles...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Desplegable: Incluye -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('includes')">
                        <div class="section-title">
                            <i class="fas fa-check-circle section-icon" style="color: #28a745;"></i>
                            Incluye
                        </div>
                        <i class="fas fa-chevron-down section-toggle" id="includes-toggle"></i>
                    </div>
                    <div class="section-content" id="includes-content">
                        <div class="section-body">
                            <div id="detail-includes">Cargando información...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Desplegable: No Incluye -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('excludes')">
                        <div class="section-title">
                            <i class="fas fa-times-circle section-icon" style="color: #dc3545;"></i>
                            No Incluye
                        </div>
                        <i class="fas fa-chevron-down section-toggle" id="excludes-toggle"></i>
                    </div>
                    <div class="section-content" id="excludes-content">
                        <div class="section-body">
                            <div id="detail-excludes">Cargando información...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Desplegable: Itinerario -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('itinerary')">
                        <div class="section-title">
                            <i class="fas fa-calendar-alt section-icon"></i>
                            Itinerario del Viaje
                        </div>
                        <i class="fas fa-chevron-down section-toggle" id="itinerary-toggle"></i>
                    </div>
                    <div class="section-content" id="itinerary-content">
                        <div class="section-body">
                            <div id="detail-itinerary">
                                <div class="itinerary-day">
                                    <div class="day-number">1</div>
                                    <div class="day-content">
                                        <h4>Llegada y Bienvenida</h4>
                                        <p>Recibimiento en el aeropuerto y traslado al hotel. Cena de bienvenida.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="package-sidebar">
                <!-- Precio -->
                <div class="package-price-card">
                    <div class="price-label">Precio por Persona</div>
                    <div class="price-amount" id="detail-price">$0</div>
                    <div class="price-note">Precios sujetos a disponibilidad</div>
                </div>
                
                <!-- Acciones -->
                <div class="package-actions">
                    <button class="btn btn-success" id="btn-cotizar">
                        <i class="fas fa-paper-plane"></i>
                        Solicitar Cotización
                    </button>
                    
                    <button class="btn btn-primary" id="btn-reservar">
                        <i class="fas fa-calendar-check"></i>
                        Reservar Ahora
                    </button>
                    
                    <button class="btn btn-secondary" id="btn-contactar">
                        <i class="fas fa-phone"></i>
                        Contactar Asesor
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mensaje de Error -->
        <div id="package-error" class="error-message" style="display: none;">
            <div class="error-icon">❌</div>
            <h2>Error al Cargar el Paquete</h2>
            <p id="error-text">No se pudo cargar la información del paquete.</p>
            <a href="packages.html" class="back-to-packages">
                <i class="fas fa-arrow-left"></i>
                Volver a Paquetes
            </a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Agencia de Viajes</h3>
                    <p>Tu compañero de confianza para explorar el mundo.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Contacto</h3>
                    <p><i class="fas fa-phone"></i> +57 300 123 4567</p>
                    <p><i class="fas fa-envelope"></i> info@agenciaviajes.com</p>
                </div>
                
                <div class="footer-section">
                    <h3>Síguenos</h3>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Agencia de Viajes. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/api.js"></script>
    
    <script>
        // Variables globales del carrusel
        let currentSlide = 0;
        let totalSlides = 1;
        let packageImages = [];
        
        // Función para limpiar etiquetas HTML y mostrar solo texto
        function stripHtmlTags(htmlString) {
            if (!htmlString) return '';
            
            // Crear un elemento temporal para parsear el HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;
            
            // Extraer solo el texto
            return tempDiv.textContent || tempDiv.innerText || '';
        }
        
        // Función para formatear el itinerario
        function formatItinerary(itineraryHtml) {
            if (!itineraryHtml) return '<p>Itinerario no disponible</p>';
            
            // Limpiar etiquetas HTML y extraer solo texto
            const cleanText = stripHtmlTags(itineraryHtml);
            
            // Dividir por días (buscar patrones como "DÍA 1", "DÍA 2", etc.)
            const days = cleanText.split(/(?=DÍA\s+\d+)/);
            
            if (days.length <= 1) {
                // Si no hay días claros, mostrar como párrafo simple
                return `<p>${cleanText}</p>`;
            }
            
            // Formatear cada día
            return days.map((day, index) => {
                if (!day.trim()) return '';
                
                const dayMatch = day.match(/DÍA\s+(\d+)[^:]*:\s*(.*)/);
                if (dayMatch) {
                    const dayNumber = dayMatch[1];
                    const dayContent = dayMatch[2].trim();
                    
                    return `
                        <div class="itinerary-day">
                            <div class="day-number">${dayNumber}</div>
                            <div class="day-content">
                                <h4>Día ${dayNumber}</h4>
                                <p>${dayContent}</p>
                            </div>
                        </div>
                    `;
                } else {
                    return `<p>${day.trim()}</p>`;
                }
            }).join('');
        }
        
        // Obtener ID del paquete de la URL
        function getPackageId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Función para alternar secciones desplegables
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + '-content');
            const toggle = document.getElementById(sectionName + '-toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        // Función para crear el carrusel de imágenes
        function createCarousel(images) {
            const container = document.getElementById('carousel-container');
            const indicators = document.getElementById('carousel-indicators');
            
            if (!images || images.length === 0) {
                // Imagen por defecto
                container.innerHTML = `
                    <div class="carousel-slide">
                        <div class="carousel-placeholder">
                            <i class="fas fa-image"></i>
                            <span>Imagen no disponible</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            packageImages = images;
            totalSlides = images.length;
            
            // Crear slides
            container.innerHTML = images.map((image, index) => `
                <div class="carousel-slide">
                    <img src="${image}" alt="Imagen ${index + 1}" class="carousel-image" 
                         onerror="this.parentElement.innerHTML='<div class=\\'carousel-placeholder\\'><i class=\\'fas fa-image\\'></i></div>'">
                </div>
            `).join('');
            
            // Crear indicadores
            indicators.innerHTML = images.map((_, index) => `
                <div class="carousel-indicator ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>
            `).join('');
            
            // Configurar navegación
            setupCarouselNavigation();
        }
        
        // Configurar navegación del carrusel
        function setupCarouselNavigation() {
            document.getElementById('carousel-prev').addEventListener('click', () => {
                goToSlide(currentSlide - 1);
            });
            
            document.getElementById('carousel-next').addEventListener('click', () => {
                goToSlide(currentSlide + 1);
            });
        }
        
        // Ir a slide específico
        function goToSlide(slideIndex) {
            if (slideIndex < 0) slideIndex = totalSlides - 1;
            if (slideIndex >= totalSlides) slideIndex = 0;
            
            currentSlide = slideIndex;
            
            const container = document.getElementById('carousel-container');
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Mover carrusel
            container.style.transform = `translateX(-${slideIndex * 100}%)`;
            
            // Actualizar indicadores
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index === slideIndex);
            });
        }
        
        // Cargar detalles del paquete
        async function loadPackageDetails(packageId) {
            try {
                console.log('📦 Cargando detalles del paquete ID:', packageId);
                
                if (!window.AgenciaAPI || !window.AgenciaAPI.getPackageById) {
                    throw new Error('AgenciaAPI no disponible');
                }
                
                const response = await window.AgenciaAPI.getPackageById(packageId);
                console.log('📡 Respuesta de la API:', response);
                
                if (response && response.success && response.data) {
                    // La API devuelve datos doble encapsulados
                    const packageData = response.data.data || response.data;
                    console.log('📦 Datos del paquete extraídos:', packageData);
                    displayPackageDetails(packageData);
                } else {
                    throw new Error('No se pudieron cargar los detalles del paquete');
                }
                
            } catch (error) {
                console.error('❌ Error al cargar detalles:', error);
                showError('Error al cargar los detalles del paquete: ' + error.message);
            }
        }
        
        // Mostrar detalles del paquete
        function displayPackageDetails(package) {
            console.log('🎨 Mostrando detalles del paquete:', package);
            
            // Ocultar loading y mostrar contenido
            document.getElementById('package-loading').style.display = 'none';
            document.getElementById('package-content').style.display = 'grid';
            
            // Actualizar contenido principal
            document.getElementById('detail-title').textContent = package.title || 'Sin título';
            document.getElementById('detail-destination').textContent = package.destination || 'No especificado';
            document.getElementById('detail-origin').textContent = package.origin || 'No especificado';
            document.getElementById('detail-duration').textContent = package.duration || '15 días';
            document.getElementById('detail-group').textContent = package.group_size || 'Grupo turístico';
            document.getElementById('detail-price').textContent = package.min_price ? '$' + package.min_price.toLocaleString() : 'Consultar';
            
            // Actualizar badge de destino
            document.getElementById('destination-badge-text').textContent = package.destination || 'No especificado';
            
            // Actualizar secciones desplegables
            // Detalles del paquete: mantener formato rico con viñetas
            document.getElementById('detail-full-description').innerHTML = package.details || package.description || 'Descripción detallada no disponible';
            document.getElementById('detail-includes').innerHTML = package.include || 'Información no disponible';
            document.getElementById('detail-excludes').innerHTML = package.no_include || 'Información no disponible';
            
            // Actualizar itinerario
            document.getElementById('detail-itinerary').innerHTML = formatItinerary(package.itinerary || 'Itinerario no disponible');
            
            // Crear carrusel de imágenes
            let images = [];
            if (package.main_image) {
                images.push(package.main_image);
            }
            if (package.gallery_images && Array.isArray(package.gallery_images)) {
                images = images.concat(package.gallery_images);
            }
            createCarousel(images);
            
            // Configurar botones
            setupButtons(package.id);
        }
        
        // Configurar botones de acción
        function setupButtons(packageId) {
            // Botón Cotizar
            document.getElementById('btn-cotizar').addEventListener('click', function() {
                window.location.href = `index.html#cotizacion?package=${packageId}`;
            });
            
            // Botón Reservar
            document.getElementById('btn-reservar').addEventListener('click', function() {
                alert('Funcionalidad de reserva en desarrollo. Por favor, contacta a un asesor.');
            });
            
            // Botón Contactar
            document.getElementById('btn-contactar').addEventListener('click', function() {
                window.location.href = `index.html#contacto?package=${packageId}`;
            });
        }
        
        // Mostrar error
        function showError(message) {
            document.getElementById('package-loading').style.display = 'none';
            document.getElementById('package-error').style.display = 'block';
            document.getElementById('error-text').textContent = message;
        }
        
        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 Página de detalles cargada');
            
            const packageId = getPackageId();
            
            if (!packageId) {
                showError('No se especificó el ID del paquete');
                return;
            }
            
            // Esperar a que AgenciaAPI esté disponible
            const checkAgenciaAPI = setInterval(() => {
                if (window.AgenciaAPI) {
                    clearInterval(checkAgenciaAPI);
                    loadPackageDetails(packageId);
                }
            }, 100);
            
            // Timeout después de 10 segundos
            setTimeout(() => {
                clearInterval(checkAgenciaAPI);
                if (!window.AgenciaAPI) {
                    showError('Error: AgenciaAPI no disponible');
                }
            }, 10000);
        });
    </script>
</body>
</html>
